<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التوقيت الاحترافي - الإصدار الفاخر</title>
        <link rel="icon" type="image/png" href="https://i.ibb.co/qMpZTTRb/Gemini-Generated-Image-91jttc91jttc91jt.png">
    <link rel="shortcut icon" href="https://i.ibb.co/qMpZTTRb/Gemini-Generated-Image-91jttc91jttc91jt.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/qMpZTTRb/Gemini-Generated-Image-91jttc91jttc91jt.png">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#020202">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta property="og:image" content="https://i.ibb.co/qMpZTTRb/Gemini-Generated-Image-91jttc91jttc91jt.png">
    <meta itemprop="image" content="https://i.ibb.co/qMpZTTRb/Gemini-Generated-Image-91jttc91jttc91jt.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flipclock/0.7.8/flipclock.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<head>
    <style>
       /* الحاوية الرئيسية */
.alarm-days-section {
    width: 100%;
    margin: 20px 0;
    text-align: right; /* لمحاذاة النص العربي */
}

/* عنوان القسم */
.section-title {
    color: #ffffff;
    font-size: 14px;
    margin-bottom: 10px;
    padding-right: 5px;
}

/* ترتيب الأيام في صف واحد */
.days-wrapper {
    display: flex;
    flex-direction: row-reverse; /* لتبدأ الأيام من اليمين لليسار */
    justify-content: space-between;
    background: #1a1a2e; /* لون خلفية داكن يناسب تطبيقك */
    padding: 10px;
    border-radius: 12px;
}

/* إخفاء المربع التقليدي */
.day-item input {
    display: none;
}

/* تصميم الدائرة أو المربع لكل يوم */
.day-item span {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: #2e2e48; /* لون الدائرة غير المحددة */
    color: #ffffff;
    font-size: 13px;
    cursor: pointer;
    transition: 0.3s all;
    border: 1px solid #3f3f5f;
}

/* التنسيق عند الضغط (الاختيار) */
.day-item input:checked + span {
    background-color: #6366f1; /* اللون البنفسجي مثل زر الإضافة */
    border-color: #a5b4fc;
    box-shadow: 0 0 8px rgba(99, 102, 241, 0.6);
}
        /* ... باقي كود الـ CSS الذي أعطيتك إياه ... */
    </style>
</head>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-dark: #020617;
            --card-bg: rgba(15, 23, 42, 0.6);
            --accent: #10b981;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --input-bg: rgba(30, 41, 59, 0.5);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            background: radial-gradient(circle at top right, #1e1b4b, #020617);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* تحسين الهيدر */
        .header { text-align: center; padding: 40px 20px; }
        #date-header { font-size: 1.1rem; color: var(--accent); font-weight: 500; margin-top: 10px; opacity: 0.9; }

        /* التبويبات */
        .tabs-container {
            display: flex; background: var(--card-bg); backdrop-filter: blur(16px);
            padding: 6px; border-radius: 24px; border: 1px solid var(--border-color);
            margin-bottom: 30px; width: 92%; max-width: 600px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .tab-button {
            flex: 1; padding: 12px 10px; background: transparent; border: none;
            color: var(--text-muted); cursor: pointer; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.95rem; font-weight: 500;
        }

        .tab-button.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }

        /* الأقسام */
        .content-section { display: none; width: 100%; max-width: 800px; flex-direction: column; align-items: center; animation: fadeIn 0.5s ease; }
        .content-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* الساعة */
       .clock-wrapper { 
    padding: 1px; 
    /* القيمة 1.0 هي الحجم الطبيعي */
    /* 1.5 تعني تكبير بنسبة 150% */
    /* 0.8 تعني تصغير بنسبة 80% */
    transform: scale(1.3); 
    margin: 20px 0; 
}
.flip-clock-wrapper ul {
    width: 62px;      /* العرض الافتراضي 60px */
    height: 92px;    /* الطول الافتراضي 90px */
    font-size: 100px; /* حجم الخط */
}

.flip-clock-wrapper ul li a div div.inn {
    font-size: 100px;  /* حجم الأرقام الداخلية */
}
@media (max-width: 600px) {
    .clock-wrapper {
        transform: scale(0.7); /* تصغير الساعة على الهواتف */
        margin: 10px 0;
    }
}        
        
        /* لوحة الإعدادات المحسنة */
        .glass-panel {
            background: var(--card-bg); backdrop-filter: blur(20px);
            border-radius: 32px; padding: 30px; width: 90%; max-width: 500px;
            border: 1px solid var(--border-color); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* تحسين عناصر الإدخال بشكل جذري */
        .input-group { margin-bottom: 20px; width: 100%; }
        .input-group label { 
            display: block; margin-bottom: 8px; color: var(--text-muted); 
            font-size: 0.85rem; font-weight: 600; padding-right: 5px;
        }

        input[type="time"], input[type="text"], input[type="number"], select {
            background: var(--input-bg); border: 2px solid transparent;
            color: white; padding: 14px 18px; border-radius: 16px; width: 100%;
            outline: none; font-size: 1rem; appearance: none;
        }

        input:focus, select:focus {
            border-color: var(--primary); background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        /* تحسين مدخلات الملفات */
        input[type="file"] {
            background: rgba(255, 255, 255, 0.03); border: 2px dashed var(--border-color);
            padding: 15px; border-radius: 16px; cursor: pointer; color: var(--text-muted);
            width: 100%; font-size: 0.85rem;
        }
        input[type="file"]:hover { border-color: var(--primary); background: rgba(255, 255, 255, 0.05); }

        /* الأزرار */
        .action-btn {
            padding: 14px 24px; border-radius: 16px; border: none;
            cursor: pointer; font-weight: 700; display: flex; align-items: center; 
            justify-content: center; gap: 10px; font-size: 1rem; width: 100%;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #818cf8); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }

        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1.5px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* قائمة التنبيهات */
        .alarm-list { width: 100%; margin-top: 25px; display: flex; flex-direction: column; gap: 12px; }
        .alarm-item {
            background: rgba(255, 255, 255, 0.03); padding: 16px; border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border-color);
        }
        .alarm-info b { font-size: 1.2rem; color: var(--primary); }

        /* واجهة الرنين */
        #ringing-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95);
            z-index: 9999; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            backdrop-filter: blur(25px); border: 8px solid var(--danger);
        }

        .auto-close-timer {
            margin-top: 15px; color: #fbbf24; font-size: 1.2rem;
            background: rgba(251, 191, 36, 0.1); padding: 8px 20px; border-radius: 30px;
        }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* تحسين الـ Chips */
        .format-chip { padding: 8px 20px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; }
        .format-chip.active { background: var(--primary) !important; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

    </style>
</head>
<body>

    <!-- واجهة الرنين -->
    <div id="ringing-overlay">
        <div style="background: rgba(239, 68, 68, 0.1); padding: 50px; border-radius: 50%; margin-bottom: 25px; animation: pulse 2s infinite;">
            <i class="fa-solid fa-bell" style="font-size: 6rem; color: var(--danger);"></i>
        </div>
        <div id="active-alarm-name" style="font-size: 3rem; font-weight: 900; margin-bottom: 5px; color: white;">تنبيه!</div>
        <div id="active-alarm-time" style="font-size: 1.8rem; margin-bottom: 20px; color: var(--text-muted);">00:00</div>
        
        <div id="auto-close-info" class="auto-close-timer"></div>

        <div style="display: flex; gap: 20px; justify-content: center; width: 100%; margin-top: 40px; padding: 0 20px;">
            <button class="action-btn" onclick="snoozeAlarm()" style="background: #ffffff; color: #000; border-radius: 20px; height: 70px; flex: 1; max-width: 200px;">غفوة (5 دق)</button>
            <button class="action-btn" onclick="stopRinging()" style="background: var(--danger); color: white; border-radius: 20px; height: 70px; flex: 1; max-width: 200px;">إغلاق</button>
        </div>
    </div>

    <div class="header">
        <h1 style="margin: 0; font-size: 2.5rem; font-weight: 900; letter-spacing: -1px; background: linear-gradient(135deg, #fff 0%, #94a3b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">نظام التوقيت الاحترافي</h1>
        <div id="date-header"></div>
    </div>

    <div class="tabs-container">
        <button class="tab-button active" onclick="showTab('clock-tab')"><i class="fa-solid fa-clock"></i> الساعة</button>
        <button class="tab-button" onclick="showTab('alarm-tab')"><i class="fa-solid fa-bell"></i> المنبهات</button>
        <button class="tab-button" onclick="showTab('countdown-tab')"><i class="fa-solid fa-hourglass-half"></i> تنازلي</button>
        <button class="tab-button" onclick="showTab('stopwatch-tab')"><i class="fa-solid fa-stopwatch-20"></i> تصاعدي</button>
    </div>

    <!-- تبويب الساعة -->
    <div id="clock-tab" class="content-section active">
        <div style="display:flex; gap:12px; margin-bottom:20px">
            <div class="format-chip active" id="chip24" onclick="setFormat('TwentyFourHourClock')" style="cursor:pointer; background:rgba(255,255,255,0.05)">24 ساعة</div>
            <div class="format-chip" id="chip12" onclick="setFormat('TwelveHourClock')" style="cursor:pointer; background:rgba(255,255,255,0.05)">12 ساعة</div>
        </div>
        <div class="clock-wrapper"><div id="live-clock-el"></div></div>
    </div>

    <!-- تبويب المنبه -->
    <div id="alarm-tab" class="content-section">
        <div class="glass-panel">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group">
                    <label>الوقت</label>
                    <input type="time" id="alarmTime">
                </div>
                <div class="input-group">
                    <label>اسم المنبه</label>
                    <input type="text" id="alarmLabel" placeholder="مثلاً: عمل...">
                </div>
            </div>
 <div class="alarm-days-section">
    <p class="section-title">تكرار التنبيه في أيام:</p>
    <div class="days-wrapper">
        <label class="day-item"><input type="checkbox" value="6"><span>س</span></label>
        <label class="day-item"><input type="checkbox" value="5"><span>ج</span></label>
        <label class="day-item"><input type="checkbox" value="4"><span>خ</span></label>
        <label class="day-item"><input type="checkbox" value="3"><span>ر</span></label>
        <label class="day-item"><input type="checkbox" value="2"><span>ث</span></label>
        <label class="day-item"><input type="checkbox" value="1"><span>ن</span></label>
        <label class="day-item"><input type="checkbox" value="0"><span>ح</span></label>
    </div>
</div>

            <div class="input-group">
                <label>طريقة الإغلاق</label>
                <select id="alarmCloseMode" onchange="toggleAutoCloseFields('alarm')">
                    <option value="manual">يدوي (يستمر بالرنين)</option>
                    <option value="auto">تلقائي (بعد مدة محددة)</option>
                </select>
            </div>

            <div id="alarmAutoCloseFields" class="duration-fields hidden" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>دقائق</label><input type="number" id="alarmCloseMins" value="0" min="0"></div>
                    <div style="flex: 1;"><label>ثواني</label><input type="number" id="alarmCloseSecs" value="30" min="0" max="59"></div>
                </div>
            </div>

            <div class="input-group">
                <label>تخصيص النغمة</label>
                <input type="file" id="toneFile" accept="audio/*" onchange="handleToneUpload(event, 'alarm')">
            </div>

            <button class="action-btn btn-primary" onclick="addAlarm()"><i class="fa-solid fa-plus"></i> إضافة منبه جديد / حفظ التعديلات </button>
            <div class="alarm-list" id="alarmList"></div>
        </div>
    </div>

    <!-- تبويب العد التنازلي -->
    <div id="countdown-tab" class="content-section">
        <div class="glass-panel">
            <div class="input-group">
                <label>المدة الإجمالية (دقائق)</label>
                <input type="number" id="mins" value="5" min="0.1" step="0.1">
            </div>
            
            <div class="input-group">
                <label>نغمة التنبيه</label>
                <input type="file" id="cdToneFile" accept="audio/*" onchange="handleToneUpload(event, 'countdown')">
            </div>

            <div class="input-group">
                <label>الإغلاق عند الانتهاء</label>
                <select id="cdCloseMode" onchange="toggleAutoCloseFields('cd')">
                    <option value="manual">يدوي</option>
                    <option value="auto">تلقائي بعد ثواني</option>
                </select>
            </div>

            <div id="cdAutoCloseFields" class="duration-fields hidden" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>دقائق</label><input type="number" id="cdCloseMins" value="0" min="0"></div>
                    <div style="flex: 1;"><label>ثواني</label><input type="number" id="cdCloseSecs" value="10" min="0" max="59"></div>
                </div>
            </div>

            <div style="display:flex; gap:12px">
                <button class="action-btn btn-primary" style="flex:2" onclick="startCountdown()"><i class="fa-solid fa-play"></i> بدء</button>
                <button class="action-btn btn-danger" style="flex:1" onclick="pauseCountdown()"><i class="fa-solid fa-pause"></i></button>
                <button class="action-btn btn-outline" style="flex:1; border: 1.5px solid var(--border-color);" onclick="resetCountdown()"><i class="fa-solid fa-rotate-left"></i></button>
            </div>
        </div>
        <div class="clock-wrapper"><div id="down-clock-el"></div></div>
    </div>

    <!-- تبويب العد التصاعدي -->
    <div id="stopwatch-tab" class="content-section">
        <div class="glass-panel">
            <div style="display:flex; gap:12px; margin-bottom: 20px;">
                <button id="sw-start-btn" class="action-btn btn-primary" style="flex:2" onclick="startStopwatch()"><i class="fa-solid fa-play"></i> بدء</button>
                <button id="sw-lap-btn" class="action-btn btn-outline" style="flex:1; border: 1.5px solid var(--border-color);" onclick="recordLap()" disabled><i class="fa-solid fa-flag"></i></button>
                <button class="action-btn btn-danger" style="flex:1" onclick="resetStopwatch()"><i class="fa-solid fa-trash-can"></i></button>
            </div>
            <div class="lap-list" id="lapList"></div>
        </div>
        <div class="clock-wrapper"><div id="stopwatch-el"></div></div>
    </div>

    <div id="toast"></div>
    <audio id="audioPlayer"></audio>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flipclock/0.7.8/flipclock.min.js"></script>

    <script>
        let liveClock, downClock, stopwatch;
        let alarms = JSON.parse(localStorage.getItem('myAlarms')) || [];
        let alarmToneURL = null;
        let cdToneURL = null;
        let currentFormat = 'TwentyFourHourClock';
        let ringingAlarm = null;
        let initialCountdownValue = null;
        let laps = [];
        let autoCloseTimerInterval = null;
        let remainingAutoCloseSecs = 0;

        const DEFAULT_AUDIO = "https://actions.google.com/sounds/v1/alarms/beep_loop.ogg";

        $(document).ready(function() {
            updateDate();
            initLiveClock();
            initStopwatch();
            renderAlarms();
            setInterval(checkAlarms, 1000);
        });

        function toggleAutoCloseFields(type) {
            const mode = type === 'alarm' ? $('#alarmCloseMode').val() : $('#cdCloseMode').val();
            const fieldId = type === 'alarm' ? '#alarmAutoCloseFields' : '#cdAutoCloseFields';
            if (mode === 'auto') $(fieldId).removeClass('hidden').hide().slideDown();
            else $(fieldId).slideUp();
        }

        function showTab(tabId) {
            $('.content-section').removeClass('active');
            $('.tab-button').removeClass('active');
            $(`#${tabId}`).addClass('active');
            $(`.tab-button[onclick="showTab('${tabId}')"]`).addClass('active');
        }

        function initLiveClock() {
            if (liveClock) liveClock.stop();
            $('#live-clock-el').empty();
            liveClock = $('#live-clock-el').FlipClock({ clockFace: currentFormat });
        }

        function setFormat(format) {
            currentFormat = format;
            $('.format-chip').removeClass('active');
            $(`#${format === 'TwelveHourClock' ? 'chip12' : 'chip24'}`).addClass('active');
            initLiveClock();
        }

 // --- المتغيرات العامة (يجب أن تكون خارج الدوال) ---
let editMode = false;
let editId = null;

// دالة رفع النغمة (مستقلة)
function handleToneUpload(event, type) {
    const file = event.target.files[0];
    if (file) {
        const url = URL.createObjectURL(file);
        if (type === 'alarm') {
            if (alarmToneURL) URL.revokeObjectURL(alarmToneURL);
            alarmToneURL = url;
        } else {
            if (cdToneURL) URL.revokeObjectURL(cdToneURL);
            cdToneURL = url;
        }
        showToast("تم تحديث نغمة التنبيه بنجاح");
    }
}

// دالة التعديل (مستقلة)
function editAlarm(id) {
    const alarm = alarms.find(a => a.id === id);
    if (!alarm) return;

    $('#alarmTime').val(alarm.time);
    $('#alarmLabel').val(alarm.label);

    $('.day-item input').prop('checked', false);
    if (alarm.days) {
        alarm.days.forEach(day => {
            $(`.day-item input[value="${day}"]`).prop('checked', true);
        });
    }

    editMode = true;
    editId = id;
    $('#addAlarmBtn').html('<i class="fa-solid fa-check"></i> حفظ التعديلات').css('background', '#10b981');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// دالة الإضافة أو الحفظ (معدلة لتشمل التعديل)
function addAlarm() {
    const time = $('#alarmTime').val();
    const label = $('#alarmLabel').val() || "منبه جديد";
    const selectedDays = Array.from(document.querySelectorAll('.day-item input:checked')).map(cb => parseInt(cb.value));

    if (!time) return showToast("يرجى تحديد وقت المنبه أولاً");

    if (editMode) {
        // --- وضع التعديل ---
        const index = alarms.findIndex(a => a.id === editId);
        if (index !== -1) {
            alarms[index].time = time;
            alarms[index].label = label;
            alarms[index].days = selectedDays;
            showToast("تم تحديث المنبه");
        }
        // إعادة الزر لحالته الطبيعية
        editMode = false;
        editId = null;
        $('#addAlarmBtn').html('<i class="fa-solid fa-plus"></i> إضافة منبه جديد').css('background', '');
    } else {
        // --- وضع الإضافة الجديد (كودك الأصلي) ---
        alarms.push({ id: Date.now(), time, label, enabled: true, days: selectedDays });
        showToast("تمت إضافة المنبه");
    }

    // تنظيف الحقول بعد الانتهاء
    $('#alarmLabel').val('');
    $('.day-item input').prop('checked', false);
    
    saveAlarms();
    renderAlarms();
}

function renderAlarms() {
    const list = $('#alarmList').empty();
    
    // مصفوفة أسماء الأيام لتحويل الأرقام إلى نصوص
    const dayNames = ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"];

    alarms.forEach(a => {
        // تحويل مصفوفة الأرقام إلى نص مفهوم
        let daysTxt = "";
        if (a.days && a.days.length > 0) {
            if (a.days.length === 7) {
                daysTxt = "يومياً";
            } else {
                daysTxt = a.days.map(d => dayNames[d]).join('، ');
            }
        } else {
            daysTxt = "مرة واحدة"; 
        }

        const closeTxt = a.autoCloseSecs > 0 ? `<div style="font-size:0.75rem; color:var(--text-muted)">إغلاق تلقائي بعد ${a.autoCloseSecs}ث</div>` : "";
        
        // نص الأيام المكررة بتنسيق صغير
        const daysHtml = `<div style="font-size:0.75rem; color:#818cf8; margin-top:2px;">تكرار: ${daysTxt}</div>`;

        list.append(`
            <div class="alarm-item">
                <div class="alarm-info">
                    <b>${a.time}</b>
                    <div style="font-size:0.9rem">${a.label}</div>
                    ${daysHtml}
                    ${closeTxt}
                </div>
                <div class="alarm-actions" style="display: flex; gap: 5px;">
                    <button class="action-btn" style="background:#10b981; width:auto; padding:8px 12px" onclick="editAlarm(${a.id})">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    
                    <button class="action-btn btn-danger" style="width:auto; padding:8px 12px" onclick="deleteAlarm(${a.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        `);
    });
}

        function deleteAlarm(id) {
            alarms = alarms.filter(a => a.id !== id);
            saveAlarms();
            renderAlarms();
        }

        function saveAlarms() { localStorage.setItem('myAlarms', JSON.stringify(alarms)); }

function checkAlarms() {
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    const currentDay = now.getDay(); // يجلب اليوم الحالي (0-6)

    if (now.getSeconds() === 0) {
        // قمنا بإضافة شرط الأيام داخل دالة البحث find
        const triggered = alarms.find(a => {
            // نتحقق أولاً من تفعيل المنبه وتطابق الوقت
            const isTimeMatch = a.enabled && a.time === timeStr;
            
            // نتحقق ثانياً: هل اليوم الحالي موجود ضمن مصفوفة الأيام الخاصة بهذا المنبه؟
            // (سأفترض أنك ستخزن الأيام داخل كل منبه في مصفوفة اسمها days)
            const isDayMatch = !a.days || a.days.length === 0 || a.days.includes(currentDay);

            return isTimeMatch && isDayMatch;
        });

        if (triggered) startRinging(triggered, 'alarm');
    }
}

        function startRinging(info, type) {
            if (ringingAlarm) return;
            ringingAlarm = info;
            $('#active-alarm-name').text(info.label);
            $('#active-alarm-time').text(info.time || "00:00");
            $('#ringing-overlay').fadeIn().css('display', 'flex');
            
            const player = document.getElementById('audioPlayer');
            player.src = (type === 'countdown' ? cdToneURL : alarmToneURL) || DEFAULT_AUDIO;
            player.loop = true;
            player.play();

            if (info.autoCloseSecs && info.autoCloseSecs > 0) {
                remainingAutoCloseSecs = info.autoCloseSecs;
                $('#auto-close-info').show().text(`سيغلق تلقائياً خلال ${remainingAutoCloseSecs} ثانية`);
                
                autoCloseTimerInterval = setInterval(() => {
                    remainingAutoCloseSecs--;
                    if (remainingAutoCloseSecs <= 0) {
                        stopRinging();
                    } else {
                        $('#auto-close-info').text(`سيغلق تلقائياً خلال ${remainingAutoCloseSecs} ثانية`);
                    }
                }, 1000);
            } else {
                $('#auto-close-info').hide();
            }
        }

        function stopRinging() {
            const player = document.getElementById('audioPlayer');
            player.pause();
            player.currentTime = 0;
            $('#ringing-overlay').fadeOut();
            ringingAlarm = null;
            if (autoCloseTimerInterval) {
                clearInterval(autoCloseTimerInterval);
                autoCloseTimerInterval = null;
            }
        }

        function snoozeAlarm() {
            stopRinging();
            showToast("تم تفعيل الغفوة لمدة 5 دقائق");
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            const snoozeTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            
            alarms.push({
                id: Date.now(),
                time: snoozeTime,
                label: "غفوة: " + ($('#active-alarm-name').text()),
                enabled: true,
                autoCloseSecs: 30
            });
            renderAlarms();
        }

        function startCountdown() {
            const mins = parseFloat($('#mins').val());
            const secs = Math.floor(mins * 60);

            if (downClock && !downClock.running && initialCountdownValue === mins) {
                downClock.start();
                return;
            }

            if (downClock) downClock.stop();
            initialCountdownValue = mins;
            $('#down-clock-el').empty();
            
            let cdAutoClose = 0;
            if ($('#cdCloseMode').val() === 'auto') {
                cdAutoClose = (parseInt($('#cdCloseMins').val()) * 60) + (parseInt($('#cdCloseSecs').val()) || 0);
            }

            downClock = $('#down-clock-el').FlipClock(secs, {
                clockFace: 'MinuteCounter',
                countdown: true,
                callbacks: {
                    stop: function() {
                        if (this.factory.getTime().time === 0) {
                            startRinging({
                                label: "انتهى الوقت المحدد", 
                                time: "00:00", 
                                autoCloseSecs: cdAutoClose
                            }, 'countdown');
                        }
                    }
                }
            });
        }

        function pauseCountdown() { if(downClock) downClock.stop(); }
        function resetCountdown() { 
            if(downClock) downClock.stop(); 
            downClock = null; 
            $('#down-clock-el').empty(); 
        }

        function initStopwatch() {
            $('#stopwatch-el').empty();
            stopwatch = $('#stopwatch-el').FlipClock(0, {
                clockFace: 'MinuteCounter',
                autoStart: false
            });
        }

        function startStopwatch() {
            if (!stopwatch.running) {
                stopwatch.start();
                $('#sw-start-btn').html('<i class="fa-solid fa-pause"></i> إيقاف مؤقت').removeClass('btn-primary').addClass('btn-danger');
                $('#sw-lap-btn').prop('disabled', false);
            } else {
                stopwatch.stop();
                $('#sw-start-btn').html('<i class="fa-solid fa-play"></i> استمرار').removeClass('btn-danger').addClass('btn-primary');
                $('#sw-lap-btn').prop('disabled', true);
            }
        }

        function resetStopwatch() {
            stopwatch.stop();
            stopwatch.setTime(0);
            laps = [];
            $('#lapList').empty();
            $('#sw-start-btn').html('<i class="fa-solid fa-play"></i> بدء').removeClass('btn-danger').addClass('btn-primary');
            $('#sw-lap-btn').prop('disabled', true);
        }

        function recordLap() {
            const time = stopwatch.getTime().time;
            const mins = Math.floor(time / 60);
            const secs = time % 60;
            const lapTime = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            laps.unshift(lapTime);
            renderLaps();
        }

        function renderLaps() {
            const list = $('#lapList').empty();
            laps.forEach((l, i) => {
                list.append(`<div class="lap-item"><span>دورة ${laps.length - i}</span> <span style="font-family:monospace; font-weight:bold; color:var(--primary)">${l}</span></div>`);
            });
        }

function updateDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const weekday = now.toLocaleDateString('ar-SA', { weekday: 'long' });
            
            // التنسيق المطلوب: (2026/1/1 , الخميس)
            const dateStr = `${year}/${month}/${day} ، ${weekday}`;
            $('#date-header').text(dateStr);
        }

        function showToast(m) { 
            $('#toast').text(m).css({
                'display': 'block',
                'background': 'var(--primary)',
                'box-shadow': '0 10px 30px rgba(0,0,0,0.5)',
                'animation': 'fadeIn 0.3s ease'
            }).fadeIn().delay(3000).fadeOut(); 
        }
        // ضع الكود الثالث هنا
        document.getElementById('addAlarmBtn').addEventListener('click', function() {
            const selectedDays = Array.from(document.querySelectorAll('.day-circle input:checked'))
                                      .map(cb => parseInt(cb.value));
            
            console.log("الأيام المختارة:", selectedDays);
            // بقية منطق حفظ المنبه...
        });
        function isAlarmDaySelected() {
    const now = new Date();
    const currentDay = now.getDay(); // الأحد 0، الاثنين 1 ... السبت 6

    // نجلب كل المربعات المختارة (Checked)
    const selectedDays = Array.from(document.querySelectorAll('.day-item input:checked'))
                              .map(cb => parseInt(cb.value));

    // إذا لم يختار المستخدم أي يوم، نعتبره منبه يعمل يومياً (أو يمكنك تغيير ذلك)
    if (selectedDays.length === 0) return true; 

    // نتحقق إذا كان رقم اليوم الحالي موجود ضمن القائمة المختارة
    return selectedDays.includes(currentDay);
}

    </script>
</body>
</html>
